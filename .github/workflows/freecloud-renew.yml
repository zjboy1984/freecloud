name: FreeCloud è‡ªåŠ¨ç»­æœŸ

on:
  workflow_dispatch:
    inputs:
      force_run:
        description: 'è·³è¿‡å»¶è¿Ÿæ‰§è¡Œ'
        required: false
        default: true
        type: boolean
  schedule:
    - cron: "2 12 * * *"  # æ¯å¤©æ—©ä¸Š10ç‚¹ï¼ˆUTC+8åŒ—äº¬æ—¶é—´ï¼‰æ‰§è¡Œï¼Œä¸ºäº†ä¿è¯ä½ çš„å®šæ—¶ç»­æœŸä»»åŠ¡èƒ½æˆåŠŸæ‰§è¡Œï¼Œå¼ºçƒˆå»ºè®®å¤§å®¶éšæœºä¿®æ”¹è¿™ä¸ªå®šæ—¶æ—¶é—´ï¼Œæ¯”å¦‚å°† "2 1 * * *"ï¼Œå°†1ä¿®æ”¹ä¸º0~16éƒ½å¯ä»¥ï¼Œä¸ä¸€å®šè¦è·Ÿæˆ‘ä¸€æ ·

jobs:
  renew:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main  # ç¡®ä¿æ£€å‡ºmainåˆ†æ”¯

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…ä¾èµ–
        run: npm install node-fetch@2

      - name: æ™ºèƒ½åˆ†æ•£å»¶è¿Ÿæ‰§è¡Œ
        id: delay_step
        run: |
          # æ£€æŸ¥æ˜¯å¦ä¸ºæ‰‹åŠ¨è·³è¿‡å»¶è¿Ÿæ‰§è¡Œ
          if [ "${{ github.event.inputs.force_run }}" = "true" ]; then
            echo "ğŸ”§ æ‰‹åŠ¨æ‰§è¡Œä¸”è·³è¿‡å»¶è¿Ÿï¼Œç«‹å³å¼€å§‹ç»­æœŸ"
            echo "delay_seconds=0" >> $GITHUB_OUTPUT
            echo "delay_type=æ‰‹åŠ¨è·³è¿‡å»¶è¿Ÿ" >> $GITHUB_OUTPUT
          else
            # åŸºäºç”¨æˆ·åå“ˆå¸Œçš„ç²¾ç¡®ç§’çº§åˆ†æ•£å»¶è¿Ÿï¼ˆ0-8åˆ†é’Ÿï¼Œ480ç§’ï¼‰
            USER_HASH=$(echo "${{ github.actor }}" | md5sum | cut -c1-6)
            echo "ğŸ” ç”¨æˆ·å“ˆå¸Œæ ‡è¯†: $USER_HASH"

            # å°†6ä½åå…­è¿›åˆ¶å“ˆå¸Œè½¬æ¢ä¸ºå»¶è¿Ÿç§’æ•°ï¼ˆ0-480ç§’ï¼Œå³0-8åˆ†é’Ÿï¼‰
            DELAY=$((0x$USER_HASH % 480))

            # è®¡ç®—åˆ†é’Ÿå’Œç§’æ•°ç”¨äºæ˜¾ç¤º
            MINUTES=$(($DELAY / 60))
            SECONDS=$(($DELAY % 60))

            echo "â° æ™ºèƒ½åˆ†æ•£å»¶è¿Ÿ $DELAY ç§’ ($MINUTES åˆ†é’Ÿ $SECONDS ç§’)"
            echo "ğŸ“Š åŸºäºç”¨æˆ·åå“ˆå¸Œçš„ç¡®å®šæ€§å»¶è¿Ÿï¼ˆ0-8åˆ†é’Ÿï¼‰ï¼Œé¿å…åŒæ—¶æ‰§è¡Œå†²çª"
            echo "delay_seconds=$DELAY" >> $GITHUB_OUTPUT
            echo "delay_type=æ™ºèƒ½åˆ†æ•£å»¶è¿Ÿ" >> $GITHUB_OUTPUT
            sleep $DELAY
          fi

      - name: æ‰§è¡Œ FreeCloud ç»­æœŸ
        run: node fcrenew.js
        env:
          # Telegram é€šçŸ¥é…ç½® (å¯é€‰)
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN || vars.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID || vars.TELEGRAM_CHAT_ID }}

          # FreeCloud é…ç½® (å¿…éœ€)
          FREECLOUD_ACCOUNTS: ${{ secrets.FREECLOUD_ACCOUNTS || vars.FREECLOUD_ACCOUNTS }}
          FREECLOUD_API_KEY: ${{ secrets.FREECLOUD_API_KEY || vars.FREECLOUD_API_KEY }}

          # å»¶è¿Ÿä¿¡æ¯
          DELAY_SECONDS: ${{ steps.delay_step.outputs.delay_seconds }}
          DELAY_TYPE: ${{ steps.delay_step.outputs.delay_type }}
