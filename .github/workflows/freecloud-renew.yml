name: FreeCloud è‡ªåŠ¨ç»­æœŸ

on:
  workflow_dispatch:
    inputs:
      force_run:
        description: 'è·³è¿‡å»¶è¿Ÿæ‰§è¡Œ'
        required: false
        default: true
        type: boolean
  schedule:
    - cron: "0 2 * * *"  # æ¯å¤©æ—©ä¸Š10ç‚¹ï¼ˆUTC+8åŒ—äº¬æ—¶é—´ï¼‰æ‰§è¡Œï¼Œå»ºè®®å¤§å®¶éšæœºä¿®æ”¹â€œ2â€è¿™ä¸ªæ—¶é—´ï¼Œä¸ä¸€å®šè¦è·Ÿæˆ‘ä¸€æ ·

jobs:
  renew:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…ä¾èµ–
        run: npm install node-fetch@2

      - name: éšæœºå»¶è¿Ÿæ‰§è¡Œ
        id: delay_step
        run: |
          # æ£€æŸ¥æ˜¯å¦ä¸ºæ‰‹åŠ¨è·³è¿‡å»¶è¿Ÿæ‰§è¡Œ
          if [ "${{ github.event.inputs.force_run }}" = "true" ]; then
            echo "ğŸ”§ æ‰‹åŠ¨æ‰§è¡Œä¸”è·³è¿‡å»¶è¿Ÿï¼Œç«‹å³å¼€å§‹ç»­æœŸ"
            echo "delay_seconds=0" >> $GITHUB_OUTPUT
            echo "delay_type=æ‰‹åŠ¨è·³è¿‡å»¶è¿Ÿ" >> $GITHUB_OUTPUT
          else
            # ç”Ÿæˆ 0-900 ç§’ï¼ˆ0-15åˆ†é’Ÿï¼‰çš„éšæœºå»¶è¿Ÿ
            DELAY=$((RANDOM % 900))
            echo "â° éšæœºå»¶è¿Ÿ $DELAY ç§’ ($(($DELAY / 60)) åˆ†é’Ÿ $(($DELAY % 60)) ç§’)"
            echo "delay_seconds=$DELAY" >> $GITHUB_OUTPUT
            echo "delay_type=éšæœºå»¶è¿Ÿ" >> $GITHUB_OUTPUT
            sleep $DELAY
          fi

      - name: æ‰§è¡Œ FreeCloud ç»­æœŸ
        run: node fcrenew.js
        env:
          # Telegram é€šçŸ¥é…ç½® (å¯é€‰)
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN || vars.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID || vars.TELEGRAM_CHAT_ID }}

          # FreeCloud é…ç½® (å¿…éœ€)
          FREECLOUD_ACCOUNTS: ${{ secrets.FREECLOUD_ACCOUNTS || vars.FREECLOUD_ACCOUNTS }}
          FREECLOUD_API_KEY: ${{ secrets.FREECLOUD_API_KEY || vars.FREECLOUD_API_KEY }}

          # å»¶è¿Ÿä¿¡æ¯
          DELAY_SECONDS: ${{ steps.delay_step.outputs.delay_seconds }}
          DELAY_TYPE: ${{ steps.delay_step.outputs.delay_type }}